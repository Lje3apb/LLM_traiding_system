# Структура проекта LLM Trading System

## Обзор

Это **система криптовалютной торговли с режимным подходом**, которая использует большие языковые модели (LLM) для анализа рыночных условий и корректировки размеров позиций. Система объединяет рыночные данные, on-chain метрики, новостной сентимент и классификацию режимов на основе LLM для принятия обоснованных торговых решений.

---

## Структура каталогов

```
/home/user/LLM_traiding_system/
├── llm_trading_system/              # Основной пакет
│   ├── __init__.py                  # Инициализация пакета
│   ├── core/                        # Основная бизнес-логика
│   │   ├── __init__.py
│   │   ├── position_sizing.py       # Расчет размера позиции на основе вероятностей режимов
│   │   ├── market_snapshot.py       # Агрегация рыночных данных из нескольких API
│   │   └── regime_engine.py         # Пайплайн оценки режимов через LLM
│   ├── infra/                       # Инфраструктурный слой
│   │   └── llm_infra/               # Абстракция провайдеров LLM
│   │       ├── __init__.py
│   │       ├── types.py             # Определения протоколов для провайдеров LLM
│   │       ├── providers_ollama.py  # Провайдер Ollama (локальные модели)
│   │       ├── providers_openai.py  # OpenAI-совместимый провайдер
│   │       ├── client_sync.py       # Синхронный LLM клиент с повторными попытками
│   │       ├── client_async.py      # Асинхронный LLM клиент
│   │       ├── retry.py             # Политики повторных попыток с экспоненциальной задержкой
│   │       ├── compressor.py        # Утилиты сжатия промптов
│   │       └── router.py            # Маршрутизация между несколькими провайдерами
│   ├── strategies/                  # Торговые стратегии
│   │   ├── __init__.py
│   │   ├── base.py                  # Базовые классы стратегий и примитивы
│   │   └── llm_regime_strategy.py   # Стратегия на основе LLM-режимов
│   ├── engine/                      # Движок бэктестинга и исполнения
│   │   ├── __init__.py
│   │   ├── backtester.py           # Движок исторического бэктестинга
│   │   ├── portfolio.py            # Симуляция портфеля и исполнение сделок
│   │   └── data_feed.py            # Исторический фид данных (поддержка CSV)
│   └── cli/                        # Инструменты командной строки
│       ├── __init__.py
│       ├── full_cycle_cli.py       # CLI полного интеграционного теста
│       ├── quick_test_ollama.py    # Быстрый тест подключения к Ollama
│       └── check_dependencies.py   # Проверка зависимостей
├── tests/                          # Набор тестов
│   ├── __init__.py
│   ├── _test_support.py            # Утилиты и хелперы для тестов
│   ├── test_position_sizing.py     # Юнит-тесты размера позиции
│   ├── test_full_cycle.py         # Полный интеграционный тест
│   ├── test_ollama.py             # Тесты провайдера Ollama
│   ├── test_onchain_apis.py       # Тесты on-chain API
│   └── test_fetch_onchain.py      # Тесты получения on-chain данных
├── setup.py                       # Установка и настройка пакета
├── requirements.txt               # Python зависимости
├── Dockerfile                     # Определение Docker контейнера
├── docker-compose.yml             # Docker оркестрация
├── Makefile                       # Автоматизация команд сборки
├── .env.example                   # Шаблон переменных окружения
├── .gitignore                     # Шаблоны игнорирования Git
├── check_ollama.sh                # Скрипт проверки статуса Ollama
├── README.md                      # Основная документация (русский)
├── OLLAMA_SETUP.md               # Руководство по настройке Ollama (русский)
├── FULL_CYCLE_TEST.md            # Руководство по полному циклу тестирования (русский)
├── LICENSE                        # Файл лицензии
└── описание тестов.txt           # Описание тестов (русский)
```

---

## Ключевые модули и их назначение

### 1. Основные модули (`llm_trading_system/core/`)

#### **position_sizing.py**
- **Назначение**: Преобразует вывод LLM о режиме в множители размера позиции
- **Ключевая функция**: `compute_position_multipliers(llm_output, side, base_long_size, base_short_size, k_max)`
- **Логика**:
  - Направленное смещение из вероятностей bull/bear
  - Корректировки на основе оценок (сентимент, on-chain, тренд)
  - Ограничение рисков (риск ликвидности, новостной риск)
  - Возвращает: position_size, k_long, k_short
- **Функции**:
  - Фильтрация мертвой зоны (d0=0.1) для игнорирования шума
  - Мультифакторная модель с настраиваемыми весами
  - Жесткая остановка при экстремальном риске (>0.9)
  - Автоматическое ограничение в диапазоне [0, k_max]

#### **market_snapshot.py**
- **Назначение**: Агрегация рыночных данных из нескольких источников
- **Источники данных** (все бесплатные API):
  - **Binance API**: Спотовые цены, объемы, ставки финансирования, книга ордеров
  - **CoinMetrics Community**: BTC on-chain метрики, предложение стейблкоинов
  - **Blockchain.com**: Метрики активности адресов (резервный)
  - **CryptoPanic**: Криптоновости и сентимент (опционально)
  - **NewsAPI**: Общие криптоновости (опционально)
- **Ключевые функции**:
  - `build_market_snapshot(settings)`: Агрегация всех данных
  - `build_system_prompt()`: Генерация системных инструкций для LLM
  - `build_user_prompt(snapshot)`: Форматирование данных для ввода в LLM
- **Вывод**: Полный снимок рынка с рыночными/on-chain/новостными данными

#### **regime_engine.py**
- **Назначение**: Пайплайн, соединяющий рыночные данные → LLM → размер позиции
- **Ключевая функция**: `evaluate_regime_and_size(snapshot, client, base_size, k_max, temperature)`
- **Поток**:
  1. Построение промптов из снимка
  2. Запрос LLM для оценки режима
  3. Парсинг и валидация JSON ответа LLM
  4. Вычисление множителей позиции
  5. Возврат консолидированных результатов
- **Вывод**: Dict с llm_output, k_long, k_short, pos_long, pos_short

---

### 2. Инфраструктура (`llm_trading_system/infra/llm_infra/`)

#### **types.py**
- Определения протоколов для провайдеров LLM
- `LLMProvider`: Интерфейс синхронного провайдера
- `AsyncLLMProvider`: Интерфейс асинхронного провайдера

#### **providers_ollama.py**
- Провайдер локальных моделей Ollama
- По умолчанию: deepseek-v3.1:671b-cloud
- Поддержка любых моделей Ollama
- Настраиваемые base_url и timeout

#### **providers_openai.py**
- OpenAI-совместимый API провайдер
- Работает с OpenAI, Azure OpenAI или совместимыми endpoint'ами

#### **client_sync.py** / **client_async.py**
- Высокоуровневые клиенты с повторными попытками и сжатием
- Автоматическое сжатие промптов при необходимости
- Настраиваемые политики повторов

#### **retry.py**
- Политики повторных попыток с экспоненциальной задержкой
- Обработка временных сбоев
- Настраиваемые max_retries и задержки

#### **compressor.py**
- Утилиты сжатия промптов
- Помогает оставаться в пределах токенов

#### **router.py**
- Маршрутизация между несколькими провайдерами
- Резервные провайдеры
- Балансировка нагрузки

---

### 3. Стратегии (`llm_trading_system/strategies/`)

#### **base.py**
- **Примитивы**:
  - `Bar`: Структура данных OHLCV
  - `Order`: Целевой ордер позиции
  - `AccountState`: Состояние портфеля
  - `Strategy`: Абстрактный базовый класс
- **Интерфейс**: `on_bar(bar, account) -> Order | None`

#### **llm_regime_strategy.py**
- Стратегия, основанная на LLM-режимах
- Периодические запросы к движку режимов
- Корректировка позиции на основе оценки LLM
- **Параметры**:
  - `horizon_bars`: Частота обновления
  - `base_size`: Базовый размер позиции
  - `k_max`: Максимальный множитель

---

### 4. Движок (`llm_trading_system/engine/`)

#### **backtester.py**
- Фреймворк исторического бэктестинга
- **Метрики**: Кривая капитала, общая доходность, максимальная просадка
- Поддержка пользовательских стратегий
- Настраиваемые комиссии и проскальзывание

#### **portfolio.py**
- Симулятор портфеля с логикой исполнения
- Обработка входа/выхода из позиций
- Симуляция комиссий и проскальзывания
- Отслеживание позиций и расчет P&L
- **Вывод**: История сделок, кривая капитала

#### **data_feed.py**
- Реализации исторического фида данных
- `CSVDataFeed`: Чтение OHLCV из CSV
- Поддержка ISO8601 временных меток и Unix секунд
- Дизайн на основе протоколов для расширяемости

---

### 5. CLI инструменты (`llm_trading_system/cli/`)

#### **full_cycle_cli.py**
- CLI полного интеграционного теста
- **Точка входа**: `llm-trading-cli` (console script)
- Режимы: Mock данные или реальные API данные
- Полный пайплайн: данные → LLM → размер → рекомендация
- **Использование**: `python -m llm_trading_system.cli.full_cycle_cli --real-data --model llama3.2`

#### **check_dependencies.py**
- Инструмент валидации зависимостей
- Проверка Python пакетов
- Проверка доступности Ollama
- Список доступных моделей
- **Точка входа**: `llm-trading-check-deps`

#### **quick_test_ollama.py**
- Быстрый тест подключения к Ollama
- **Точка входа**: `llm-trading-test-ollama`

---

### 6. Тесты (`tests/`)

#### **test_position_sizing.py**
- Юнит-тесты логики размера позиции
- Тестирование всех крайних случаев и режимов
- Покрытие: clamp, safe_get_score, multipliers
- ~19 тестовых случаев

#### **test_full_cycle.py**
- Интеграционный тест с dummy LLM
- Тестирование полного пайплайна
- Генерация mock снимков

#### **test_ollama.py**
- Интеграционные тесты провайдера Ollama

#### **test_onchain_apis.py** / **test_fetch_onchain.py**
- Тесты получения on-chain данных
- Валидация API endpoint'ов

---

## Конфигурационные файлы

### **setup.py**
- Метаданные пакета и установка
- Точки входа console scripts:
  - `llm-trading-cli`
  - `llm-trading-check-deps`
  - `llm-trading-test-ollama`
- Зависимости: requests>=2.32.3
- Требование Python: >=3.12

### **requirements.txt**
- Основные: `requests==2.32.3`
- Тестирование: `pytest==8.3.3`
- Опциональные dev инструменты закомментированы

### **.env.example**
- Шаблон для переменных окружения
- API ключи (CryptoPanic, NewsAPI)
- Базовые настройки (BASE_ASSET, HORIZON_HOURS)
- Параметры размера позиции (BASE_LONG_SIZE, K_MAX)
- API endpoint'ы (Binance, CoinMetrics и т.д.)

### **docker-compose.yml**
- Три профиля сервисов:
  1. **llm-trading** (по умолчанию): Запуск размера позиции
  2. **test**: Запуск набора тестов
  3. **market-snapshot**: Запуск сбора рыночных данных
- Лимиты ресурсов: 2 CPU, 1GB RAM

### **Dockerfile**
- База Python 3.12-slim
- Non-root пользователь для безопасности
- Оптимизированное кеширование слоев

### **Makefile**
- Быстрые команды для общих задач
- Docker и локальное выполнение
- Запуск тестов
- Настройка окружения

---

## Документационные файлы

### **README.md** (русский)
- Комплексная документация проекта
- Инструкции по настройке
- Примеры использования
- Справка по API
- Руководство по устранению неполадок

### **OLLAMA_SETUP.md** (русский)
- Руководство по установке Ollama
- Рекомендации по выбору модели
- Инструкции по конфигурации
- Общие проблемы и решения

### **FULL_CYCLE_TEST.md** (русский)
- Руководство по сквозному тестированию
- Объяснение компонентов
- Ожидаемые выводы
- Устранение неполадок

---

## Точки входа и основные скрипты

### Console Scripts (через setup.py)
1. **llm-trading-cli**: Полный интеграционный тест
2. **llm-trading-check-deps**: Проверка зависимостей
3. **llm-trading-test-ollama**: Быстрый тест Ollama

### Прямое выполнение модулей
```bash
# Примеры размера позиции
python -m llm_trading_system.core.position_sizing

# Сбор рыночных данных
python -m llm_trading_system.core.market_snapshot

# Полный цикл теста
python -m llm_trading_system.cli.full_cycle_cli

# Запуск тестов
python -m pytest tests/ -v
```

### Выполнение в Docker
```bash
# Сборка и запуск
docker-compose up --build

# Запуск тестов
docker-compose --profile test up test

# Снимок рынка
docker-compose --profile market up market-snapshot
```

---

## Поток данных

```
1. Сбор рыночных данных (market_snapshot.py)
   ↓
   [Binance] → Цена, Объем, Финансирование, OI
   [CoinMetrics] → BTC метрики, Стейблкоины
   [Blockchain.com] → Активность адресов
   [CryptoPanic/NewsAPI] → Новости и сентимент
   ↓
2. Агрегация снимка
   ↓
3. Генерация промптов (build_system_prompt, build_user_prompt)
   ↓
4. Запрос LLM (через llm_infra)
   ↓
5. Парсинг ответа (regime_engine.py)
   ↓
   JSON: {prob_bull, prob_bear, scores, reasoning}
   ↓
6. Размер позиции (position_sizing.py)
   ↓
   Множители: k_long, k_short
   ↓
7. Торговое решение
   ↓
   [Strategy] → Order → [Portfolio] → Execution
```

---

## Ключевые особенности

1. **Модульная архитектура**: Четкое разделение обязанностей
2. **Множественные источники данных**: Бесплатные API, без подписок
3. **LLM-агностичность**: Работает с Ollama, OpenAI или совместимыми провайдерами
4. **Управление рисками**: Автоматическое ограничение позиции на основе метрик риска
5. **Бэктестинг**: Полный движок бэктестинга с реалистичным исполнением
6. **Готовность к Docker**: Полная контейнеризация
7. **Комплексное тестирование**: Юнит и интеграционные тесты
8. **Хорошо задокументирован**: Обширная документация на русском языке
9. **Type Hints**: Полные аннотации типов для Python 3.12+
10. **Готовность к продакшену**: Логика повторов, обработка ошибок, логирование

---

## Технологический стек

- **Язык**: Python 3.12+
- **Основные зависимости**: requests (HTTP), pytest (тестирование)
- **LLM**: Ollama (локальный) или OpenAI-совместимые API
- **Источники данных**: Binance, CoinMetrics, Blockchain.com, CryptoPanic, NewsAPI
- **Контейнеризация**: Docker + Docker Compose
- **Инструмент сборки**: Make

---

## Краткое резюме быстрого старта

```bash
# 1. Настройка окружения
cp .env.example .env
make setup

# 2. Установка зависимостей
pip install -r requirements.txt

# 3. Запуск Ollama (для LLM)
ollama serve
ollama pull llama3.2

# 4. Запуск тестов
make test

# 5. Запуск полного цикла
python -m llm_trading_system.cli.full_cycle_cli

# Или с Docker
docker-compose up --build
```

---

## Архитектурные принципы

### Разделение ответственности
- **core/**: Бизнес-логика (режимы, размер позиции, рыночные данные)
- **infra/**: Технические детали (LLM клиенты, провайдеры, повторы)
- **strategies/**: Торговые стратегии (изолированы от инфраструктуры)
- **engine/**: Симуляция и исполнение (портфель, бэктестинг, данные)
- **cli/**: Пользовательский интерфейс (точки входа, инструменты)

### Принцип инверсии зависимостей
- Использование Protocol вместо абстрактных классов
- LLM провайдеры взаимозаменяемы
- Стратегии не зависят от конкретных источников данных
- Data feeds абстрагированы через протоколы

### Расширяемость
- Легко добавить новые источники данных
- Простое добавление новых LLM провайдеров
- Модульные стратегии
- Гибкая система бэктестинга

---

Это хорошо структурированная, готовая к продакшену торговая система с отличным разделением обязанностей, комплексным тестированием и тщательной документацией.
