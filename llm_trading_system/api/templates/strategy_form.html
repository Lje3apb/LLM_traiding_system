{% extends "base.html" %}

{% block title %}{{ 'Edit' if name else 'New' }} Strategy - LLM Trading System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ 'Edit Strategy: ' + name if name else 'Create New Strategy' }}</h2>
</div>

<form method="POST" action="/ui/strategies/{{ name if name else 'new' }}/save" class="strategy-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="form-section">
        <h3>Basic Settings</h3>

        <div class="form-group">
            <label for="name">Strategy Name</label>
            <input type="text" id="name" name="name" value="{{ name or '' }}" {% if name %}readonly{% endif %} required>
        </div>

        <div class="form-group">
            <label for="strategy_type">Strategy Type</label>
            <select id="strategy_type" name="strategy_type" required>
                <option value="indicator" {% if config.get('strategy_type') == 'indicator' %}selected{% endif %}>Indicator</option>
                <option value="combined" {% if config.get('strategy_type') == 'combined' %}selected{% endif %}>Combined</option>
            </select>
        </div>

        <div class="form-group">
            <label for="mode">Mode</label>
            <select id="mode" name="mode" required>
                <option value="quant_only" {% if config.get('mode') == 'quant_only' %}selected{% endif %}>Quant Only</option>
                <option value="llm_only" {% if config.get('mode') == 'llm_only' %}selected{% endif %}>LLM Only</option>
                <option value="hybrid" {% if config.get('mode') == 'hybrid' %}selected{% endif %}>Hybrid</option>
            </select>
        </div>

        <div class="form-group">
            <label for="symbol">Symbol</label>
            <input type="text" id="symbol" name="symbol" value="{{ config.get('symbol', 'BTCUSDT') }}" required>
        </div>

        <div class="form-group">
            <label for="base_size">Base Size</label>
            <input type="number" id="base_size" name="base_size" value="{{ config.get('base_size', 0.1) }}" step="0.01" min="0" required>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="allow_long" {% if config.get('allow_long', True) %}checked{% endif %}>
                Allow Long
            </label>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="allow_short" {% if config.get('allow_short', False) %}checked{% endif %}>
                Allow Short
            </label>
        </div>
    </div>

    <div class="form-section">
        <h3>Indicator Parameters</h3>

        <div class="form-row">
            <div class="form-group">
                <label for="ema_fast_len">EMA Fast Length</label>
                <input type="number" id="ema_fast_len" name="ema_fast_len" value="{{ config.get('ema_fast_len', 12) }}" min="1" required>
            </div>

            <div class="form-group">
                <label for="ema_slow_len">EMA Slow Length</label>
                <input type="number" id="ema_slow_len" name="ema_slow_len" value="{{ config.get('ema_slow_len', 26) }}" min="1" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="rsi_len">RSI Length</label>
                <input type="number" id="rsi_len" name="rsi_len" value="{{ config.get('rsi_len', 14) }}" min="1" required>
            </div>

            <div class="form-group">
                <label for="rsi_ovb">RSI Overbought</label>
                <input type="number" id="rsi_ovb" name="rsi_ovb" value="{{ config.get('rsi_ovb', 70) }}" min="0" max="100" required>
                <small class="help-text" style="color: #6b7280;">Must be greater than RSI Oversold</small>
            </div>

            <div class="form-group">
                <label for="rsi_ovs">RSI Oversold</label>
                <input type="number" id="rsi_ovs" name="rsi_ovs" value="{{ config.get('rsi_ovs', 30) }}" min="0" max="100" required>
                <small class="help-text" style="color: #6b7280;">Must be less than RSI Overbought</small>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="bb_len">Bollinger Bands Length</label>
                <input type="number" id="bb_len" name="bb_len" value="{{ config.get('bb_len', 20) }}" min="1" required>
            </div>

            <div class="form-group">
                <label for="bb_mult">Bollinger Bands Std Dev</label>
                <input type="number" id="bb_mult" name="bb_mult" value="{{ config.get('bb_mult', 2.0) }}" step="0.1" min="0" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="atr_len">ATR Length</label>
                <input type="number" id="atr_len" name="atr_len" value="{{ config.get('atr_len', 14) }}" min="1" required>
            </div>

            <div class="form-group">
                <label for="adx_len">ADX Length</label>
                <input type="number" id="adx_len" name="adx_len" value="{{ config.get('adx_len', 14) }}" min="1" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="vol_ma_len">Volume MA Length</label>
                <input type="number" id="vol_ma_len" name="vol_ma_len" value="{{ config.get('vol_ma_len', 21) }}" min="1" required>
                <small class="help-text">Length of volume moving average</small>
            </div>

            <div class="form-group">
                <label for="vol_mult">Volume Multiplier (vol_mult)</label>
                <input type="number" id="vol_mult" name="vol_mult" value="{{ config.get('vol_mult', 0.5) }}" step="0.1" min="0" required>
                <small class="help-text">Volume threshold = vol_ma * vol_mult</small>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Risk / Money Management</h3>
        <p class="help-text" style="margin-bottom: 1rem;">
            <strong>Live Trading Note:</strong> In <strong>Paper Mode</strong>, you specify an initial deposit for simulation. In <strong>Real Mode</strong>, the initial deposit is ignored and your actual exchange balance is used instead.
        </p>

        <div class="form-row">
            <div class="form-group">
                <label for="base_position_pct">Base Position (% of equity)</label>
                <input type="number" id="base_position_pct" name="base_position_pct" value="{{ config.get('base_position_pct', 10.0) }}" step="0.1" min="0" max="100">
                <small class="help-text">Percentage of equity for the first entry (applies to both paper and real trading)</small>
            </div>

            <div class="form-group">
                <label for="pyramiding">Max Pyramiding (entries)</label>
                <input type="number" id="pyramiding" name="pyramiding" value="{{ config.get('pyramiding', 1) }}" min="1" max="10">
                <small class="help-text">Maximum number of concurrent entries</small>
            </div>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="use_martingale" id="use_martingale" {% if config.get('use_martingale', False) %}checked{% endif %}>
                Use Martingale
            </label>
            <small class="help-text">Enable martingale position scaling</small>
        </div>

        <div class="form-row" id="martingale_settings" style="display: {% if config.get('use_martingale', False) %}flex{% else %}none{% endif %};">
            <div class="form-group">
                <label for="martingale_mult">Martingale Multiplier</label>
                <input type="number" id="martingale_mult" name="martingale_mult" value="{{ config.get('martingale_mult', 1.5) }}" step="0.1" min="1.0">
                <small class="help-text">Multiplier for martingale sizing (e.g., 1.5 means 1, 1.5, 2.25...)</small>
            </div>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="use_tp_sl" id="use_tp_sl" {% if config.get('use_tp_sl', False) %}checked{% endif %}>
                Enable TP/SL
            </label>
            <small class="help-text">Automatically close positions at take profit or stop loss levels</small>
        </div>

        <div id="tp_sl_settings" style="display: {% if config.get('use_tp_sl', False) %}block{% else %}none{% endif %};">
            <div class="form-row">
                <div class="form-group">
                    <label for="tp_long_pct">TP Long (%)</label>
                    <input type="number" id="tp_long_pct" name="tp_long_pct" value="{{ config.get('tp_long_pct', 2.0) }}" step="0.1" min="0">
                    <small class="help-text">Take profit for long positions</small>
                </div>

                <div class="form-group">
                    <label for="sl_long_pct">SL Long (%)</label>
                    <input type="number" id="sl_long_pct" name="sl_long_pct" value="{{ config.get('sl_long_pct', 2.0) }}" step="0.1" min="0">
                    <small class="help-text">Stop loss for long positions</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="tp_short_pct">TP Short (%)</label>
                    <input type="number" id="tp_short_pct" name="tp_short_pct" value="{{ config.get('tp_short_pct', 2.0) }}" step="0.1" min="0">
                    <small class="help-text">Take profit for short positions</small>
                </div>

                <div class="form-group">
                    <label for="sl_short_pct">SL Short (%)</label>
                    <input type="number" id="sl_short_pct" name="sl_short_pct" value="{{ config.get('sl_short_pct', 2.0) }}" step="0.1" min="0">
                    <small class="help-text">Stop loss for short positions</small>
                </div>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Time Filter (Trading Hours)</h3>
        <p class="help-text" style="margin-bottom: 1rem;">
            <strong>Note:</strong> Time filter allows you to restrict trading to specific hours (UTC timezone).
            When enabled, the strategy will only enter new positions during the specified time window.
            Existing positions will be managed (TP/SL, exit rules) regardless of time.
        </p>

        <div class="form-group">
            <label>
                <input type="checkbox" name="time_filter_enabled" id="time_filter_enabled" {% if config.get('time_filter_enabled', False) %}checked{% endif %}>
                Enable Time Filter
            </label>
            <small class="help-text">Restrict trading to specific hours (UTC timezone)</small>
        </div>

        <div class="form-row" id="time_filter_settings">
            <div class="form-group">
                <label for="time_filter_start_hour">Start Hour (UTC)</label>
                <input type="number" id="time_filter_start_hour" name="time_filter_start_hour" value="{{ config.get('time_filter_start_hour', 0) }}" min="0" max="23" step="1">
                <small class="help-text">Trading starts at this hour (0-23, UTC timezone)</small>
            </div>

            <div class="form-group">
                <label for="time_filter_end_hour">End Hour (UTC)</label>
                <input type="number" id="time_filter_end_hour" name="time_filter_end_hour" value="{{ config.get('time_filter_end_hour', 23) }}" min="0" max="23" step="1">
                <small class="help-text">Trading ends at this hour (0-23, UTC timezone)</small>
            </div>
        </div>

        <div class="form-group">
            <small class="help-text">
                <strong>Examples:</strong><br>
                • Day trading (09:00-17:00 UTC): Start=9, End=17<br>
                • Night trading (22:00-06:00 UTC): Start=22, End=6 (wrap-around supported)<br>
                • Asian session (00:00-08:00 UTC): Start=0, End=8
            </small>
        </div>

        <script>
            // Show/hide settings based on checkboxes
            (function() {
                // Generic function to toggle settings visibility
                function setupCheckboxToggle(checkboxId, settingsId, displayStyle) {
                    displayStyle = displayStyle || 'flex';

                    function toggle() {
                        const checkbox = document.getElementById(checkboxId);
                        const settings = document.getElementById(settingsId);
                        if (checkbox && settings) {
                            settings.style.display = checkbox.checked ? displayStyle : 'none';
                        }
                    }

                    // Add event listener when DOM is ready
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            toggle();
                            const checkbox = document.getElementById(checkboxId);
                            if (checkbox) {
                                checkbox.addEventListener('change', toggle);
                            }
                        });
                    } else {
                        // DOM already loaded
                        toggle();
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.addEventListener('change', toggle);
                        }
                    }
                }

                // Setup all checkbox toggles
                setupCheckboxToggle('time_filter_enabled', 'time_filter_settings', 'flex');
                setupCheckboxToggle('use_martingale', 'martingale_settings', 'flex');
                setupCheckboxToggle('use_tp_sl', 'tp_sl_settings', 'block');
            })();
        </script>
    </div>

    <div class="form-section">
        <h3>LLM Parameters (for LLM_ONLY and HYBRID modes)</h3>
        <p class="help-text" style="margin-bottom: 1rem;">
            <strong>Live Trading Note:</strong> When LLM mode is enabled in live trading, the strategy will adjust position sizes based on LLM regime predictions (bullish/bearish/neutral). This multiplies the base position size by a regime-specific factor (k).
        </p>

        <div class="form-row">
            <div class="form-group">
                <label for="k_max">K Max</label>
                <input type="number" id="k_max" name="k_max" value="{{ config.get('k_max', 2.0) }}" step="0.1" min="0">
                <small class="help-text">Maximum position multiplier for strong regime signals</small>
            </div>

            <div class="form-group">
                <label for="llm_horizon_hours">LLM Horizon (hours)</label>
                <input type="number" id="llm_horizon_hours" name="llm_horizon_hours" value="{{ config.get('llm_horizon_hours', 24) }}" min="1">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="llm_min_prob_edge">LLM Min Prob Edge</label>
                <input type="number" id="llm_min_prob_edge" name="llm_min_prob_edge" value="{{ config.get('llm_min_prob_edge', 0.55) }}" step="0.01" min="0" max="1">
            </div>

            <div class="form-group">
                <label for="llm_min_trend_strength">LLM Min Trend Strength</label>
                <input type="number" id="llm_min_trend_strength" name="llm_min_trend_strength" value="{{ config.get('llm_min_trend_strength', 0.6) }}" step="0.01" min="0" max="1">
            </div>
        </div>

        <div class="form-group">
            <label for="llm_refresh_interval_bars">LLM Refresh Interval (bars)</label>
            <input type="number" id="llm_refresh_interval_bars" name="llm_refresh_interval_bars" value="{{ config.get('llm_refresh_interval_bars', 60) }}" min="1">
        </div>
    </div>

    <div class="form-section">
        <h3>Trading Rules (JSON format)</h3>
        <p class="help-text">Define entry and exit rules using JSON. Example: <code>[{"left": "ema_fast", "op": "cross_above", "right": "ema_slow"}]</code></p>

        <div class="form-group">
            <label for="rules_long_entry">Long Entry Rules</label>
            <textarea id="rules_long_entry" name="rules_long_entry" rows="3">{{ config.get('rules', {}).get('long_entry', []) | tojson }}</textarea>
        </div>

        <div class="form-group">
            <label for="rules_short_entry">Short Entry Rules</label>
            <textarea id="rules_short_entry" name="rules_short_entry" rows="3">{{ config.get('rules', {}).get('short_entry', []) | tojson }}</textarea>
        </div>

        <div class="form-group">
            <label for="rules_long_exit">Long Exit Rules</label>
            <textarea id="rules_long_exit" name="rules_long_exit" rows="3">{{ config.get('rules', {}).get('long_exit', []) | tojson }}</textarea>
        </div>

        <div class="form-group">
            <label for="rules_short_exit">Short Exit Rules</label>
            <textarea id="rules_short_exit" name="rules_short_exit" rows="3">{{ config.get('rules', {}).get('short_exit', []) | tojson }}</textarea>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Strategy</button>
        <a href="/ui/" class="btn btn-secondary">Cancel</a>
        {% if name %}
        <a href="/ui/strategies/{{ name }}/backtest" class="btn btn-success">Run Backtest</a>
        {% endif %}
    </div>
</form>

<script>
    // Client-side validation for strategy parameters
    (function() {
        const form = document.querySelector('.strategy-form');
        if (!form) return;

        // Validate RSI thresholds
        function validateRSI() {
            const rsi_ovs = parseFloat(document.getElementById('rsi_ovs').value) || 0;
            const rsi_ovb = parseFloat(document.getElementById('rsi_ovb').value) || 0;
            const ovs_input = document.getElementById('rsi_ovs');
            const ovb_input = document.getElementById('rsi_ovb');

            if (rsi_ovs >= rsi_ovb) {
                ovs_input.setCustomValidity('RSI Oversold must be less than RSI Overbought');
                ovb_input.setCustomValidity('RSI Overbought must be greater than RSI Oversold');
                return false;
            } else {
                ovs_input.setCustomValidity('');
                ovb_input.setCustomValidity('');
                return true;
            }
        }

        // Validate TP/SL values when enabled
        function validateTPSL() {
            const use_tp_sl = document.querySelector('input[name="use_tp_sl"]').checked;

            // Clear all validation errors if checkbox is disabled
            if (!use_tp_sl) {
                ['tp_long_pct', 'sl_long_pct', 'tp_short_pct', 'sl_short_pct'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.setCustomValidity('');
                });
                return true;
            }

            const tp_long = parseFloat(document.getElementById('tp_long_pct').value) || 0;
            const sl_long = parseFloat(document.getElementById('sl_long_pct').value) || 0;
            const tp_short = parseFloat(document.getElementById('tp_short_pct').value) || 0;
            const sl_short = parseFloat(document.getElementById('sl_short_pct').value) || 0;

            let valid = true;

            if (tp_long <= 0) {
                document.getElementById('tp_long_pct').setCustomValidity('TP Long % must be greater than 0');
                valid = false;
            } else {
                document.getElementById('tp_long_pct').setCustomValidity('');
            }

            if (sl_long <= 0) {
                document.getElementById('sl_long_pct').setCustomValidity('SL Long % must be greater than 0');
                valid = false;
            } else {
                document.getElementById('sl_long_pct').setCustomValidity('');
            }

            if (tp_short <= 0) {
                document.getElementById('tp_short_pct').setCustomValidity('TP Short % must be greater than 0');
                valid = false;
            } else {
                document.getElementById('tp_short_pct').setCustomValidity('');
            }

            if (sl_short <= 0) {
                document.getElementById('sl_short_pct').setCustomValidity('SL Short % must be greater than 0');
                valid = false;
            } else {
                document.getElementById('sl_short_pct').setCustomValidity('');
            }

            return valid;
        }

        // Validate base position percentage
        function validateBasePosition() {
            const base_position_pct = parseFloat(document.getElementById('base_position_pct').value) || 0;
            const input = document.getElementById('base_position_pct');

            if (base_position_pct <= 0 || base_position_pct > 100) {
                input.setCustomValidity('Base Position % must be between 0 and 100');
                return false;
            } else {
                input.setCustomValidity('');
                return true;
            }
        }

        // Validate pyramiding
        function validatePyramiding() {
            const pyramiding = parseInt(document.getElementById('pyramiding').value) || 0;
            const input = document.getElementById('pyramiding');

            if (pyramiding < 1) {
                input.setCustomValidity('Pyramiding must be at least 1');
                return false;
            } else {
                input.setCustomValidity('');
                return true;
            }
        }

        // Add event listeners for real-time validation
        ['rsi_ovs', 'rsi_ovb'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', validateRSI);
                el.addEventListener('blur', validateRSI);
            }
        });

        ['tp_long_pct', 'sl_long_pct', 'tp_short_pct', 'sl_short_pct'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', validateTPSL);
                el.addEventListener('blur', validateTPSL);
            }
        });

        const use_tp_sl = document.querySelector('input[name="use_tp_sl"]');
        if (use_tp_sl) {
            use_tp_sl.addEventListener('change', validateTPSL);
        }

        const base_position = document.getElementById('base_position_pct');
        if (base_position) {
            base_position.addEventListener('input', validateBasePosition);
            base_position.addEventListener('blur', validateBasePosition);
        }

        const pyramiding = document.getElementById('pyramiding');
        if (pyramiding) {
            pyramiding.addEventListener('input', validatePyramiding);
            pyramiding.addEventListener('blur', validatePyramiding);
        }

        // Form submit validation
        form.addEventListener('submit', function(e) {
            const valid = validateRSI() && validateTPSL() && validateBasePosition() && validatePyramiding();

            if (!valid) {
                e.preventDefault();
                alert('Please fix validation errors before saving the strategy.');
                return false;
            }
        });

        // Run initial validation
        validateRSI();
        validateTPSL();
        validateBasePosition();
        validatePyramiding();
    })();
</script>
{% endblock %}
