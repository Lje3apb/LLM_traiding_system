{% extends "base.html" %}

{% block title %}Backtest Results - {{ name }} - LLM Trading System{% endblock %}

{% block content %}
<style>
    :root {
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --neutral-color: #6b7280;
        --bg-success: rgba(16, 185, 129, 0.1);
        --bg-danger: rgba(239, 68, 68, 0.1);
        --border-color: #e5e7eb;
        --text-muted: #6b7280;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .page-header h2 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 600;
        color: #1f2937;
    }

    .results-summary {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .results-summary h3 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .metric {
        display: flex;
        flex-direction: column;
        padding: 0.75rem;
        background: #f9fafb;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }

    .metric-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .metric-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    .metric-value.positive {
        color: var(--success-color);
    }

    .metric-value.negative {
        color: var(--danger-color);
    }

    /* Chart Section */
    .chart-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .chart-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .chart-controls button,
    .chart-controls label {
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        background: white;
        color: #374151;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.15s;
    }

    .chart-controls button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .chart-controls button.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .chart-controls label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .chart-controls input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    #chart-container {
        width: 100%;
        height: 500px;
        position: relative;
    }

    /* Trades Table */
    .trades-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .trades-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .trades-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
    }

    .trade-filters {
        display: flex;
        gap: 0.5rem;
    }

    .trade-filters button {
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        background: white;
        color: #374151;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.15s;
    }

    .trade-filters button:hover {
        background: #f3f4f6;
    }

    .trade-filters button.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .table-container {
        overflow-x: auto;
        margin-top: 1rem;
    }

    .trades-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }

    .trades-table th {
        background: #f9fafb;
        padding: 0.75rem 0.5rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid var(--border-color);
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    .trades-table th:hover {
        background: #f3f4f6;
    }

    .trades-table th.sortable::after {
        content: ' ⇅';
        color: #9ca3af;
        font-size: 0.75rem;
    }

    .trades-table th.sort-asc::after {
        content: ' ↑';
        color: #3b82f6;
    }

    .trades-table th.sort-desc::after {
        content: ' ↓';
        color: #3b82f6;
    }

    .trades-table td {
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .trades-table tr.profit {
        background: var(--bg-success);
    }

    .trades-table tr.loss {
        background: var(--bg-danger);
    }

    .trades-table tr:hover {
        background: #f9fafb;
        cursor: pointer;
    }

    .trades-table tr.profit:hover {
        background: rgba(16, 185, 129, 0.15);
    }

    .trades-table tr.loss:hover {
        background: rgba(239, 68, 68, 0.15);
    }

    .trade-type-long {
        color: var(--success-color);
        font-weight: 600;
    }

    .trade-type-short {
        color: var(--danger-color);
        font-weight: 600;
    }

    .pnl-positive {
        color: var(--success-color);
        font-weight: 600;
    }

    .pnl-negative {
        color: var(--danger-color);
        font-weight: 600;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-start;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        transition: all 0.15s;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .btn-warning:hover {
        background: #d97706;
    }

    /* Next Actions Panel */
    .next-actions {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .next-actions h3 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
    }

    .action-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .action-buttons .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    .error {
        background: var(--bg-danger);
        color: var(--danger-color);
        padding: 1rem;
        border-radius: 6px;
        margin: 1rem 0;
    }

    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        #chart-container {
            height: 400px;
        }

        .chart-controls {
            flex-wrap: wrap;
        }

        .trades-table {
            font-size: 0.75rem;
        }

        .trades-table th,
        .trades-table td {
            padding: 0.5rem 0.25rem;
        }
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
        padding: 2rem 1rem;
    }

    .modal-overlay.active {
        display: flex;
        align-items: flex-start;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 900px;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        position: relative;
        margin: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6b7280;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        line-height: 1;
        border-radius: 4px;
        transition: background 0.15s;
    }

    .modal-close:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-section {
        margin-bottom: 2rem;
    }

    .modal-section:last-child {
        margin-bottom: 0;
    }

    .modal-section h4 {
        margin: 0 0 1rem 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .param-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .param-group {
        display: flex;
        flex-direction: column;
    }

    .param-group label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
    }

    .param-group input,
    .param-group select,
    .param-group textarea {
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.875rem;
        font-family: inherit;
        transition: border-color 0.15s;
    }

    .param-group input:focus,
    .param-group select:focus,
    .param-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .param-group textarea {
        font-family: monospace;
        resize: vertical;
        min-height: 100px;
    }

    .param-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-top: 0.25rem;
        cursor: pointer;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        position: sticky;
        bottom: 0;
        background: white;
        z-index: 10;
    }

    .modal-status {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .modal-status.loading {
        color: #3b82f6;
    }

    .modal-status.success {
        color: var(--success-color);
    }

    .modal-status.error {
        color: var(--danger-color);
    }

    .modal-buttons {
        display: flex;
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        .modal-content {
            max-width: 100%;
            margin: 0;
        }

        .param-grid {
            grid-template-columns: 1fr;
        }

        .modal-footer {
            flex-direction: column;
            align-items: stretch;
        }

        .modal-buttons {
            flex-direction: column;
        }
    }
</style>

<div class="page-header">
    <h2>Backtest Results: {{ name }}</h2>
    <div style="display: flex; gap: 0.5rem;">
        <button id="edit-params-btn" class="btn btn-primary" type="button">
            <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Edit Strategy Params
        </button>
        <a href="/ui/strategies/{{ name }}/edit" class="btn btn-secondary">Edit Strategy</a>
    </div>
</div>

<div class="results-summary">
    <h3>Summary</h3>
    <div class="metrics-grid">
        <div class="metric">
            <span class="metric-label">Symbol</span>
            <span class="metric-value">{{ summary.symbol }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Bars</span>
            <span class="metric-value">{{ summary.bars }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Trades</span>
            <span class="metric-value">{{ summary.trades }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">P&L</span>
            <span class="metric-value {% if summary.pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
                {{ "+" if summary.pnl_pct >= 0 else "" }}{{ "%.2f"|format(summary.pnl_pct) }}%
            </span>
        </div>
        <div class="metric">
            <span class="metric-label">P&L (Absolute)</span>
            <span class="metric-value {% if summary.pnl_abs >= 0 %}positive{% else %}negative{% endif %}">
                ${{ "%.2f"|format(summary.pnl_abs) }}
            </span>
        </div>
        <div class="metric">
            <span class="metric-label">Max Drawdown</span>
            <span class="metric-value negative">{{ "%.2f"|format(summary.max_drawdown) }}%</span>
        </div>
        <div class="metric">
            <span class="metric-label">Win Rate</span>
            <span class="metric-value">{{ "%.1f"|format(summary.win_rate) }}%</span>
        </div>
        <div class="metric">
            <span class="metric-label">Avg Trade P&L</span>
            <span class="metric-value {% if summary.avg_trade_pnl >= 0 %}positive{% else %}negative{% endif %}">
                ${{ "%.2f"|format(summary.avg_trade_pnl) }}
            </span>
        </div>
        <div class="metric">
            <span class="metric-label">Final Equity</span>
            <span class="metric-value">${{ "%.2f"|format(summary.final_equity) }}</span>
        </div>
    </div>
</div>

<!-- Next Actions Panel -->
<div class="next-actions">
    <h3>Next Actions</h3>
    <div class="action-buttons">
        <a href="/ui/strategies/{{ name }}/backtest" class="btn btn-secondary">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Repeat Backtest
        </a>
        <a href="/ui/live?strategy={{ name }}&symbol={{ summary.symbol }}&timeframe=5m&mode=paper&deposit={{ '%.0f'|format(summary.final_equity) }}" class="btn btn-success">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Go Live (Paper Test)
        </a>
        {% if live_enabled %}
        <a href="/ui/live?strategy={{ name }}&symbol={{ summary.symbol }}&timeframe=5m&mode=real" class="btn btn-warning">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            Go Live (Real Trading)
        </a>
        {% endif %}
    </div>
</div>

<div class="chart-section">
    <div class="chart-header">
        <h3>Price Chart & Trades</h3>
        <div class="chart-controls">
            <button class="time-range-btn" data-range="1d">1d</button>
            <button class="time-range-btn" data-range="7d">7d</button>
            <button class="time-range-btn" data-range="1m">1m</button>
            <button class="time-range-btn active" data-range="all">All</button>
            <label>
                <input type="checkbox" id="toggle-trades" checked>
                Show Trades
            </label>
        </div>
    </div>
    <div id="chart-container"></div>
    <div id="chart-loading" class="loading">Loading chart data...</div>
</div>

<div class="trades-section">
    <div class="trades-header">
        <h3>Trades</h3>
        <div class="trade-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="long">Long</button>
            <button class="filter-btn" data-filter="short">Short</button>
            <button class="filter-btn" data-filter="profit">Profitable</button>
            <button class="filter-btn" data-filter="loss">Loss</button>
        </div>
    </div>
    <div class="table-container">
        <table class="trades-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="index">#</th>
                    <th class="sortable" data-sort="type">Type</th>
                    <th class="sortable" data-sort="entry_time">Entry Time</th>
                    <th class="sortable" data-sort="entry_price">Entry Price</th>
                    <th class="sortable" data-sort="exit_time">Exit Time</th>
                    <th class="sortable" data-sort="exit_price">Exit Price</th>
                    <th class="sortable" data-sort="size">Size</th>
                    <th class="sortable" data-sort="pnl_pct">PnL %</th>
                    <th class="sortable" data-sort="pnl_abs">PnL $</th>
                    <th class="sortable" data-sort="bars">Bars</th>
                </tr>
            </thead>
            <tbody id="trades-table-body">
                <tr><td colspan="10" class="loading">Loading trades...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="form-actions">
    <a href="/ui/" class="btn btn-secondary">Back to Strategies</a>
    <a href="/ui/strategies/{{ name }}/backtest" class="btn btn-primary">Run Again</a>
</div>

<!-- Edit Strategy Parameters Modal -->
<div id="params-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Strategy Parameters</h3>
            <button class="modal-close" id="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="params-form">
                <!-- Strategy Type & Mode -->
                <div class="modal-section">
                    <h4>Strategy Type & Mode</h4>
                    <div class="param-grid">
                        <div class="param-group">
                            <label for="param_strategy_type">Strategy Type</label>
                            <select id="param_strategy_type" name="strategy_type">
                                <option value="indicator">Indicator</option>
                                <option value="llm">LLM</option>
                                <option value="hybrid">Hybrid</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label for="param_mode">Mode</label>
                            <select id="param_mode" name="mode">
                                <option value="quant_only">Quant Only</option>
                                <option value="llm_only">LLM Only</option>
                                <option value="hybrid">Hybrid</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label for="param_symbol">Symbol</label>
                            <input type="text" id="param_symbol" name="symbol" placeholder="BTCUSDT">
                        </div>
                    </div>
                </div>

                <!-- Indicator Parameters -->
                <div class="modal-section">
                    <h4>Indicator Parameters</h4>
                    <div class="param-grid">
                        <div class="param-group">
                            <label for="param_rsi_len">RSI Length</label>
                            <input type="number" id="param_rsi_len" name="rsi_len" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_rsi_ovb">RSI Overbought</label>
                            <input type="number" id="param_rsi_ovb" name="rsi_ovb" min="0" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_rsi_ovs">RSI Oversold</label>
                            <input type="number" id="param_rsi_ovs" name="rsi_ovs" min="0" max="100" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_bb_len">BB Length</label>
                            <input type="number" id="param_bb_len" name="bb_len" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_bb_mult">BB Multiplier</label>
                            <input type="number" id="param_bb_mult" name="bb_mult" min="0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="param_ema_fast_len">EMA Fast Length</label>
                            <input type="number" id="param_ema_fast_len" name="ema_fast_len" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_ema_slow_len">EMA Slow Length</label>
                            <input type="number" id="param_ema_slow_len" name="ema_slow_len" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_atr_len">ATR Length</label>
                            <input type="number" id="param_atr_len" name="atr_len" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_adx_len">ADX Length</label>
                            <input type="number" id="param_adx_len" name="adx_len" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_vol_ma_len">Volume MA Length</label>
                            <input type="number" id="param_vol_ma_len" name="vol_ma_len" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_vol_mult">Volume Multiplier</label>
                            <input type="number" id="param_vol_mult" name="vol_mult" min="0" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- Position & Risk Management -->
                <div class="modal-section">
                    <h4>Position & Risk Management</h4>
                    <div class="param-grid">
                        <div class="param-group">
                            <label for="param_base_size">Base Size</label>
                            <input type="number" id="param_base_size" name="base_size" min="0" max="1" step="0.01">
                        </div>
                        <div class="param-group">
                            <label for="param_base_position_pct">Base Position %</label>
                            <input type="number" id="param_base_position_pct" name="base_position_pct" min="0" max="100" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="param_pyramiding">Pyramiding</label>
                            <input type="number" id="param_pyramiding" name="pyramiding" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_martingale_mult">Martingale Multiplier</label>
                            <input type="number" id="param_martingale_mult" name="martingale_mult" min="1" step="0.1">
                        </div>
                        <div class="param-group">
                            <label>
                                <input type="checkbox" id="param_allow_long" name="allow_long">
                                Allow Long
                            </label>
                        </div>
                        <div class="param-group">
                            <label>
                                <input type="checkbox" id="param_allow_short" name="allow_short">
                                Allow Short
                            </label>
                        </div>
                        <div class="param-group">
                            <label>
                                <input type="checkbox" id="param_use_martingale" name="use_martingale">
                                Use Martingale
                            </label>
                        </div>
                    </div>
                </div>

                <!-- TP/SL Settings -->
                <div class="modal-section">
                    <h4>TP/SL Settings</h4>
                    <div class="param-grid">
                        <div class="param-group">
                            <label>
                                <input type="checkbox" id="param_use_tp_sl" name="use_tp_sl">
                                Use TP/SL
                            </label>
                        </div>
                        <div class="param-group">
                            <label for="param_tp_long_pct">TP Long %</label>
                            <input type="number" id="param_tp_long_pct" name="tp_long_pct" min="0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="param_sl_long_pct">SL Long %</label>
                            <input type="number" id="param_sl_long_pct" name="sl_long_pct" min="0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="param_tp_short_pct">TP Short %</label>
                            <input type="number" id="param_tp_short_pct" name="tp_short_pct" min="0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="param_sl_short_pct">SL Short %</label>
                            <input type="number" id="param_sl_short_pct" name="sl_short_pct" min="0" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- Time Filter -->
                <div class="modal-section">
                    <h4>Time Filter</h4>
                    <div class="param-grid">
                        <div class="param-group">
                            <label>
                                <input type="checkbox" id="param_time_filter_enabled" name="time_filter_enabled">
                                Enable Time Filter
                            </label>
                        </div>
                        <div class="param-group">
                            <label for="param_time_filter_start_hour">Start Hour (UTC)</label>
                            <input type="number" id="param_time_filter_start_hour" name="time_filter_start_hour" min="0" max="23" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_time_filter_end_hour">End Hour (UTC)</label>
                            <input type="number" id="param_time_filter_end_hour" name="time_filter_end_hour" min="0" max="23" step="1">
                        </div>
                    </div>
                </div>

                <!-- LLM Parameters -->
                <div class="modal-section">
                    <h4>LLM Parameters</h4>
                    <div class="param-grid">
                        <div class="param-group">
                            <label for="param_k_max">K Max</label>
                            <input type="number" id="param_k_max" name="k_max" min="0" step="0.1">
                        </div>
                        <div class="param-group">
                            <label for="param_llm_horizon_hours">Horizon Hours</label>
                            <input type="number" id="param_llm_horizon_hours" name="llm_horizon_hours" min="1" step="1">
                        </div>
                        <div class="param-group">
                            <label for="param_llm_min_prob_edge">Min Prob Edge</label>
                            <input type="number" id="param_llm_min_prob_edge" name="llm_min_prob_edge" min="0" max="1" step="0.01">
                        </div>
                        <div class="param-group">
                            <label for="param_llm_min_trend_strength">Min Trend Strength</label>
                            <input type="number" id="param_llm_min_trend_strength" name="llm_min_trend_strength" min="0" max="1" step="0.01">
                        </div>
                        <div class="param-group">
                            <label for="param_llm_refresh_interval_bars">Refresh Interval (bars)</label>
                            <input type="number" id="param_llm_refresh_interval_bars" name="llm_refresh_interval_bars" min="1" step="1">
                        </div>
                    </div>
                </div>

                <!-- Trading Rules -->
                <div class="modal-section">
                    <h4>Trading Rules (JSON Format)</h4>
                    <div class="param-group">
                        <label for="param_rules">Rules JSON</label>
                        <textarea id="param_rules" name="rules" placeholder='{"long_entry": [], "short_entry": [], "long_exit": [], "short_exit": []}'></textarea>
                        <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">Enter valid JSON format for trading rules</small>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <div class="modal-status" id="modal-status"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" id="recalculate-btn">
                    Recalculate
                </button>
                <button type="button" class="btn btn-success" id="save-params-btn">
                    Save
                </button>
                <button type="button" class="btn btn-secondary" id="modal-cancel-btn">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lightweight Charts Library -->
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<script>
    // Global state
    let chartInstance = null;
    let candlestickSeries = null;
    let volumeSeries = null;
    let chartData = null;
    let tradesData = null;
    let currentFilter = 'all';
    let currentSort = { column: 'index', direction: 'asc' };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await loadChartData();
        setupEventListeners();
    });

    // Load chart and trades data
    async function loadChartData() {
        try {
            const response = await fetch('/ui/backtest/{{ name }}/chart-data');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            chartData = data;
            tradesData = data.trades || [];

            document.getElementById('chart-loading').style.display = 'none';
            initializeChart(data.ohlcv, data.trades);
            renderTradesTable(tradesData);
        } catch (error) {
            console.error('Failed to load chart data:', error);
            const loadingEl = document.getElementById('chart-loading');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = 'Failed to load chart data: ' + error.message;
            loadingEl.innerHTML = '';  // Clear first
            loadingEl.appendChild(errorDiv);
        }
    }

    // Initialize Lightweight Charts
    function initializeChart(ohlcv, trades) {
        const container = document.getElementById('chart-container');

        chartInstance = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 500,
            layout: {
                background: { color: '#ffffff' },
                textColor: '#333',
            },
            grid: {
                vertLines: { color: '#f0f0f0' },
                horzLines: { color: '#f0f0f0' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#e0e0e0',
            },
            timeScale: {
                borderColor: '#e0e0e0',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // Add candlestick series
        candlestickSeries = chartInstance.addCandlestickSeries({
            upColor: '#10b981',
            downColor: '#ef4444',
            borderUpColor: '#10b981',
            borderDownColor: '#ef4444',
            wickUpColor: '#10b981',
            wickDownColor: '#ef4444',
        });

        candlestickSeries.setData(ohlcv);

        // Add volume series
        volumeSeries = chartInstance.addHistogramSeries({
            color: '#9ca3af',
            priceFormat: {
                type: 'volume',
            },
            priceScaleId: '',
            scaleMargins: {
                top: 0.8,
                bottom: 0,
            },
        });

        const volumeData = ohlcv.map(d => ({
            time: d.time,
            value: d.volume || 0,
            color: d.close >= d.open ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'
        }));
        volumeSeries.setData(volumeData);

        // Add trade markers
        updateTradeMarkers(trades);

        // Auto-resize
        window.addEventListener('resize', () => {
            chartInstance.applyOptions({
                width: container.clientWidth
            });
        });

        // Fit content
        chartInstance.timeScale().fitContent();
    }

    // Update trade markers on chart
    function updateTradeMarkers(trades) {
        if (!candlestickSeries || !trades) return;

        const markers = [];

        trades.forEach(trade => {
            const isLong = trade.side.toUpperCase() === 'LONG';

            // Entry marker
            markers.push({
                time: trade.entry_time,
                position: isLong ? 'belowBar' : 'aboveBar',
                color: isLong ? '#10b981' : '#ef4444',
                shape: isLong ? 'arrowUp' : 'arrowDown',
                text: `${trade.side} Entry`,
            });

            // Exit marker
            if (trade.exit_time) {
                markers.push({
                    time: trade.exit_time,
                    position: isLong ? 'aboveBar' : 'belowBar',
                    color: isLong ? '#10b981' : '#ef4444',
                    shape: isLong ? 'arrowDown' : 'arrowUp',
                    text: `${trade.side} Exit`,
                });
            }
        });

        candlestickSeries.setMarkers(markers);
    }

    // Render trades table
    function renderTradesTable(trades) {
        const tbody = document.getElementById('trades-table-body');

        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #6b7280;">No trades to display</td></tr>';
            return;
        }

        // Apply filter
        let filteredTrades = filterTrades(trades, currentFilter);

        // Apply sort
        filteredTrades = sortTrades(filteredTrades, currentSort.column, currentSort.direction);

        tbody.innerHTML = filteredTrades.map((trade, idx) => {
            const pnlPct = ((trade.exit_price - trade.entry_price) / trade.entry_price * 100) * (trade.side.toUpperCase() === 'LONG' ? 1 : -1);
            const pnlAbs = trade.pnl || 0;
            const isProfit = pnlAbs > 0;
            const size = trade.size || 0;

            return `
                <tr class="${isProfit ? 'profit' : 'loss'}" data-trade-index="${idx}">
                    <td>${idx + 1}</td>
                    <td class="trade-type-${trade.side.toLowerCase()}">${trade.side.toUpperCase()}</td>
                    <td>${formatDateTime(trade.entry_time)}</td>
                    <td>$${trade.entry_price.toFixed(2)}</td>
                    <td>${formatDateTime(trade.exit_time)}</td>
                    <td>$${trade.exit_price.toFixed(2)}</td>
                    <td>${(size * 100).toFixed(1)}%</td>
                    <td class="${isProfit ? 'pnl-positive' : 'pnl-negative'}">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</td>
                    <td class="${isProfit ? 'pnl-positive' : 'pnl-negative'}">${pnlAbs >= 0 ? '+' : ''}$${pnlAbs.toFixed(2)}</td>
                    <td>${trade.bars_held || '-'}</td>
                </tr>
            `;
        }).join('');
    }

    // Filter trades
    function filterTrades(trades, filter) {
        switch (filter) {
            case 'long':
                return trades.filter(t => t.side.toUpperCase() === 'LONG');
            case 'short':
                return trades.filter(t => t.side.toUpperCase() === 'SHORT');
            case 'profit':
                return trades.filter(t => (t.pnl || 0) > 0);
            case 'loss':
                return trades.filter(t => (t.pnl || 0) < 0);
            default:
                return trades;
        }
    }

    // Sort trades
    function sortTrades(trades, column, direction) {
        const sorted = [...trades].sort((a, b) => {
            let aVal, bVal;

            switch (column) {
                case 'type':
                    aVal = a.side;
                    bVal = b.side;
                    break;
                case 'entry_time':
                    aVal = new Date(a.entry_time).getTime();
                    bVal = new Date(b.entry_time).getTime();
                    break;
                case 'exit_time':
                    aVal = new Date(a.exit_time).getTime();
                    bVal = new Date(b.exit_time).getTime();
                    break;
                case 'entry_price':
                    aVal = a.entry_price;
                    bVal = b.entry_price;
                    break;
                case 'exit_price':
                    aVal = a.exit_price;
                    bVal = b.exit_price;
                    break;
                case 'size':
                    aVal = a.size || 0;
                    bVal = b.size || 0;
                    break;
                case 'pnl_pct':
                    aVal = ((a.exit_price - a.entry_price) / a.entry_price) * (a.side.toUpperCase() === 'LONG' ? 1 : -1);
                    bVal = ((b.exit_price - b.entry_price) / b.entry_price) * (b.side.toUpperCase() === 'LONG' ? 1 : -1);
                    break;
                case 'pnl_abs':
                    aVal = a.pnl || 0;
                    bVal = b.pnl || 0;
                    break;
                case 'bars':
                    aVal = a.bars_held || 0;
                    bVal = b.bars_held || 0;
                    break;
                default:
                    return 0;
            }

            if (aVal < bVal) return direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return direction === 'asc' ? 1 : -1;
            return 0;
        });

        return sorted;
    }

    // Format datetime
    function formatDateTime(timestamp) {
        if (!timestamp) return '-';
        // Backend sends Unix timestamp in seconds, JS Date expects milliseconds
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Setup event listeners
    function setupEventListeners() {
        // Time range buttons
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const range = this.dataset.range;
                applyTimeRange(range);
            });
        });

        // Toggle trades checkbox
        document.getElementById('toggle-trades').addEventListener('change', function() {
            if (this.checked) {
                updateTradeMarkers(tradesData);
            } else {
                candlestickSeries.setMarkers([]);
            }
        });

        // Trade filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                currentFilter = this.dataset.filter;
                renderTradesTable(tradesData);
            });
        });

        // Table sorting
        document.querySelectorAll('.trades-table th.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.sort;

                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                // Update UI
                document.querySelectorAll('.trades-table th').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                this.classList.add(`sort-${currentSort.direction}`);

                renderTradesTable(tradesData);
            });
        });

        // Trade row click - highlight on chart
        document.getElementById('trades-table-body').addEventListener('click', function(e) {
            const row = e.target.closest('tr[data-trade-index]');
            if (row) {
                const idx = parseInt(row.dataset.tradeIndex);
                const trade = tradesData[idx];
                if (trade && chartInstance) {
                    chartInstance.timeScale().setVisibleRange({
                        from: trade.entry_time - 86400, // 1 day before
                        to: (trade.exit_time || trade.entry_time) + 86400 // 1 day after
                    });
                }
            }
        });
    }

    // Apply time range filter
    function applyTimeRange(range) {
        if (!chartInstance || !chartData) return;

        const now = Date.now() / 1000;
        let from;

        switch (range) {
            case '1d':
                from = now - 86400;
                break;
            case '7d':
                from = now - 7 * 86400;
                break;
            case '1m':
                from = now - 30 * 86400;
                break;
            case 'all':
            default:
                chartInstance.timeScale().fitContent();
                return;
        }

        chartInstance.timeScale().setVisibleRange({
            from: from,
            to: now
        });
    }

    // ============================================================================
    // Modal & Parameters Management
    // ============================================================================

    let currentParams = null;
    const modal = document.getElementById('params-modal');
    const editParamsBtn = document.getElementById('edit-params-btn');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const recalculateBtn = document.getElementById('recalculate-btn');
    const saveParamsBtn = document.getElementById('save-params-btn');
    const modalStatus = document.getElementById('modal-status');

    // Get CSRF token from cookie
    function getCsrfToken() {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; csrf_token=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }

    // Open modal
    editParamsBtn.addEventListener('click', async () => {
        try {
            // Load parameters from API
            setModalStatus('Loading parameters...', 'loading');
            const response = await fetch('/ui/strategies/{{ name }}/params');
            if (!response.ok) {
                throw new Error(`Failed to load parameters: ${response.status}`);
            }

            const data = await response.json();
            if (!data.success) {
                throw new Error('Failed to load parameters');
            }

            currentParams = data.params;

            // Populate form
            populateForm(currentParams);

            // Show modal
            modal.classList.add('active');
            setModalStatus('', '');
        } catch (error) {
            console.error('Failed to load parameters:', error);
            alert('Failed to load parameters: ' + error.message);
        }
    });

    // Close modal
    function closeModal() {
        modal.classList.remove('active');
        setModalStatus('', '');
    }

    modalCloseBtn.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Populate form with parameters
    function populateForm(params) {
        // Strategy Type & Mode
        document.getElementById('param_strategy_type').value = params.strategy_type || 'indicator';
        document.getElementById('param_mode').value = params.mode || 'quant_only';
        document.getElementById('param_symbol').value = params.symbol || 'BTCUSDT';

        // Indicator Parameters
        document.getElementById('param_rsi_len').value = params.rsi_len || 14;
        document.getElementById('param_rsi_ovb').value = params.rsi_ovb || 70;
        document.getElementById('param_rsi_ovs').value = params.rsi_ovs || 30;
        document.getElementById('param_bb_len').value = params.bb_len || 20;
        document.getElementById('param_bb_mult').value = params.bb_mult || 2.0;
        document.getElementById('param_ema_fast_len').value = params.ema_fast_len || 12;
        document.getElementById('param_ema_slow_len').value = params.ema_slow_len || 26;
        document.getElementById('param_atr_len').value = params.atr_len || 14;
        document.getElementById('param_adx_len').value = params.adx_len || 14;
        document.getElementById('param_vol_ma_len').value = params.vol_ma_len || 21;
        document.getElementById('param_vol_mult').value = params.vol_mult || 0.5;

        // Position & Risk Management
        document.getElementById('param_base_size').value = params.base_size || 0.1;
        document.getElementById('param_base_position_pct').value = params.base_position_pct || 10.0;
        document.getElementById('param_pyramiding').value = params.pyramiding || 1;
        document.getElementById('param_martingale_mult').value = params.martingale_mult || 1.5;
        document.getElementById('param_allow_long').checked = params.allow_long !== false;
        document.getElementById('param_allow_short').checked = params.allow_short !== false;
        document.getElementById('param_use_martingale').checked = params.use_martingale === true;

        // TP/SL
        document.getElementById('param_use_tp_sl').checked = params.use_tp_sl === true;
        document.getElementById('param_tp_long_pct').value = params.tp_long_pct || 2.0;
        document.getElementById('param_sl_long_pct').value = params.sl_long_pct || 2.0;
        document.getElementById('param_tp_short_pct').value = params.tp_short_pct || 2.0;
        document.getElementById('param_sl_short_pct').value = params.sl_short_pct || 2.0;

        // Time Filter
        document.getElementById('param_time_filter_enabled').checked = params.time_filter_enabled === true;
        document.getElementById('param_time_filter_start_hour').value = params.time_filter_start_hour || 0;
        document.getElementById('param_time_filter_end_hour').value = params.time_filter_end_hour || 23;

        // LLM Parameters
        document.getElementById('param_k_max').value = params.k_max || 2.0;
        document.getElementById('param_llm_horizon_hours').value = params.llm_horizon_hours || 24;
        document.getElementById('param_llm_min_prob_edge').value = params.llm_min_prob_edge || 0.55;
        document.getElementById('param_llm_min_trend_strength').value = params.llm_min_trend_strength || 0.6;
        document.getElementById('param_llm_refresh_interval_bars').value = params.llm_refresh_interval_bars || 60;

        // Trading Rules
        document.getElementById('param_rules').value = JSON.stringify(params.rules || {}, null, 2);
    }

    // Collect form parameters
    function collectFormParams() {
        const form = document.getElementById('params-form');
        const formData = new FormData(form);

        const params = {};

        // Get all form fields
        for (const [key, value] of formData.entries()) {
            const element = form.elements[key];

            if (element.type === 'checkbox') {
                params[key] = element.checked;
            } else if (element.type === 'number') {
                params[key] = parseFloat(value) || 0;
            } else {
                params[key] = value;
            }
        }

        // Parse rules JSON
        try {
            const rulesText = document.getElementById('param_rules').value.trim();
            if (rulesText) {
                params.rules = JSON.parse(rulesText);
            } else {
                params.rules = currentParams.rules || {};
            }
        } catch (e) {
            throw new Error('Invalid JSON in trading rules: ' + e.message);
        }

        return params;
    }

    // Set modal status message
    function setModalStatus(message, type = '') {
        modalStatus.textContent = message;
        modalStatus.className = 'modal-status';
        if (type) {
            modalStatus.classList.add(type);
        }
    }

    // Recalculate backtest with new parameters
    recalculateBtn.addEventListener('click', async () => {
        try {
            // Collect parameters
            const params = collectFormParams();

            // Disable buttons
            recalculateBtn.disabled = true;
            saveParamsBtn.disabled = true;
            setModalStatus('Recalculating backtest...', 'loading');

            // Send recalculate request
            const response = await fetch('/ui/strategies/{{ name }}/recalculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf_token: getCsrfToken(),
                    params: params
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Recalculate failed: ${response.status}`);
            }

            const data = await response.json();

            if (!data.success) {
                throw new Error('Recalculate failed');
            }

            // Update summary on page
            updateSummary(data.summary);

            // Reload chart data
            await loadChartData();

            setModalStatus('Backtest recalculated successfully!', 'success');

            // Store updated params
            currentParams = params;

        } catch (error) {
            console.error('Recalculate failed:', error);
            setModalStatus('Error: ' + error.message, 'error');
        } finally {
            // Re-enable buttons
            recalculateBtn.disabled = false;
            saveParamsBtn.disabled = false;
        }
    });

    // Save parameters
    saveParamsBtn.addEventListener('click', async () => {
        try {
            // Collect parameters
            const params = collectFormParams();

            // Disable buttons
            saveParamsBtn.disabled = true;
            recalculateBtn.disabled = true;
            setModalStatus('Saving parameters...', 'loading');

            // Send save request
            const response = await fetch('/ui/strategies/{{ name }}/save-params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf_token: getCsrfToken(),
                    params: params
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Save failed: ${response.status}`);
            }

            const data = await response.json();

            if (!data.success) {
                throw new Error('Save failed');
            }

            setModalStatus('Parameters saved successfully!', 'success');

            // Close modal after a short delay
            setTimeout(() => {
                closeModal();
            }, 1500);

        } catch (error) {
            console.error('Save failed:', error);
            setModalStatus('Error: ' + error.message, 'error');
        } finally {
            // Re-enable buttons
            saveParamsBtn.disabled = false;
            recalculateBtn.disabled = false;
        }
    });

    // Update summary on page
    function updateSummary(summary) {
        // Update metrics in results-summary section
        const metricsGrid = document.querySelector('.results-summary .metrics-grid');

        // Find and update each metric
        const metricElements = {
            'Symbol': summary.symbol,
            'Bars': summary.bars,
            'Trades': summary.trades,
            'P&L': `${summary.pnl_pct >= 0 ? '+' : ''}${summary.pnl_pct.toFixed(2)}%`,
            'P&L (Absolute)': `$${summary.pnl_abs.toFixed(2)}`,
            'Max Drawdown': `${summary.max_drawdown.toFixed(2)}%`,
            'Win Rate': `${summary.win_rate.toFixed(1)}%`,
            'Avg Trade P&L': `$${summary.avg_trade_pnl.toFixed(2)}`,
            'Final Equity': `$${summary.final_equity.toFixed(2)}`
        };

        // Update each metric
        const metrics = metricsGrid.querySelectorAll('.metric');
        metrics.forEach(metric => {
            const label = metric.querySelector('.metric-label').textContent;
            const valueEl = metric.querySelector('.metric-value');

            if (metricElements[label] !== undefined) {
                valueEl.textContent = metricElements[label];

                // Update color classes
                valueEl.classList.remove('positive', 'negative');
                if (label === 'P&L' || label === 'P&L (Absolute)') {
                    if (summary.pnl_pct >= 0 || summary.pnl_abs >= 0) {
                        valueEl.classList.add('positive');
                    } else {
                        valueEl.classList.add('negative');
                    }
                } else if (label === 'Avg Trade P&L') {
                    if (summary.avg_trade_pnl >= 0) {
                        valueEl.classList.add('positive');
                    } else {
                        valueEl.classList.add('negative');
                    }
                }
            }
        });
    }
</script>
{% endblock %}
