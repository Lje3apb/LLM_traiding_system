{% extends "base.html" %}
{% from "macros/metrics.html" import metric, pnl_class %}
{% from "macros/params.html" import number_input, text_input, checkbox, select, textarea %}

{% block title %}Backtest Results - {{ name }} - LLM Trading System{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', path='css/backtest.css') }}">

<div class="page-header">
    <h2>Backtest Results: {{ name }}</h2>
    <div class="btn-group">
        <button id="edit-params-btn" class="btn btn-primary btn-icon" type="button">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Edit Strategy Params
        </button>
        <a href="/ui/strategies/{{ name }}/edit" class="btn btn-secondary">Edit Strategy</a>
    </div>
</div>

<div class="results-summary card">
    <h3>Summary</h3>
    <div class="metrics-grid">
        {{ metric("Symbol", summary.symbol) }}
        {{ metric("Bars", summary.bars) }}
        {{ metric("Trades", summary.trades) }}
        {{ metric("P&L", "%+.2f%%"|format(summary.pnl_pct), pnl_class(summary.pnl_pct)) }}
        {{ metric("P&L (Absolute)", "$%.2f"|format(summary.pnl_abs), pnl_class(summary.pnl_abs)) }}
        {{ metric("Max Drawdown", "%.2f%%"|format(summary.max_drawdown), "negative") }}
        {{ metric("Win Rate", "%.1f%%"|format(summary.win_rate)) }}
        {{ metric("Avg Trade P&L", "$%.2f"|format(summary.avg_trade_pnl), pnl_class(summary.avg_trade_pnl)) }}
        {{ metric("Final Equity", "$%.2f"|format(summary.final_equity)) }}
    </div>
</div>

<div class="next-actions card">
    <h3>Next Actions</h3>
    <div class="btn-group">
        <a href="/ui/strategies/{{ name }}/backtest" class="btn btn-secondary btn-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Repeat Backtest
        </a>
        <a href="/ui/live?strategy={{ name }}&symbol={{ summary.symbol }}&timeframe=5m&mode=paper&deposit={{ '%.0f'|format(summary.final_equity) }}" class="btn btn-success btn-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Go Live (Paper Test)
        </a>
        {% if live_enabled %}
        <a href="/ui/live?strategy={{ name }}&symbol={{ summary.symbol }}&timeframe=5m&mode=real" class="btn btn-warning btn-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            Go Live (Real Trading)
        </a>
        {% endif %}
    </div>
</div>

<div class="chart-section card">
    <div class="chart-header">
        <h3>Price Chart & Trades</h3>
        <div class="chart-controls">
            <button class="time-range-btn" data-range="1d">1d</button>
            <button class="time-range-btn" data-range="7d">7d</button>
            <button class="time-range-btn" data-range="1m">1m</button>
            <button class="time-range-btn active" data-range="all">All</button>
            <label>
                <input type="checkbox" id="toggle-trades" checked>
                Show Trades
            </label>
        </div>
    </div>
    <div id="chart-container">
        <div class="chart-wrapper">
            <div class="chart-title">Price ({{ summary.symbol }})</div>
            <div id="price-chart"></div>
        </div>
        <div class="chart-wrapper">
            <div class="chart-title">Volume</div>
            <div id="volume-chart"></div>
        </div>
    </div>
    <div id="chart-loading" class="loading">Loading chart data...</div>
</div>

<div class="trades-section card">
    <div class="trades-header">
        <h3>Trades</h3>
        <div class="trade-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="long">Long</button>
            <button class="filter-btn" data-filter="short">Short</button>
            <button class="filter-btn" data-filter="profit">Profitable</button>
            <button class="filter-btn" data-filter="loss">Loss</button>
        </div>
    </div>
    <div class="table-container">
        <table class="trades-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="index">#</th>
                    <th class="sortable" data-sort="type">Type</th>
                    <th class="sortable" data-sort="entry_time">Entry Time</th>
                    <th class="sortable" data-sort="entry_price">Entry Price</th>
                    <th class="sortable" data-sort="exit_time">Exit Time</th>
                    <th class="sortable" data-sort="exit_price">Exit Price</th>
                    <th class="sortable" data-sort="size">Size</th>
                    <th class="sortable" data-sort="pnl_pct">PnL %</th>
                    <th class="sortable" data-sort="pnl_abs">PnL $</th>
                    <th class="sortable" data-sort="bars">Bars</th>
                </tr>
            </thead>
            <tbody id="trades-table-body">
                <tr><td colspan="10" class="loading">Loading trades...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="form-actions">
    <a href="/ui/" class="btn btn-secondary">Back to Strategies</a>
    <a href="/ui/strategies/{{ name }}/backtest" class="btn btn-primary">Run Again</a>
</div>

<!-- Edit Strategy Parameters Modal -->
<div id="params-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 8px; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                </svg>
                Edit Strategy Parameters
                <span style="font-size: 0.75rem; font-weight: 400; color: #9ca3af; margin-left: 0.5rem;">(drag to move)</span>
            </h3>
            <button class="modal-close" id="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="params-form">
                <!-- Strategy Type & Mode -->
                <div class="modal-section">
                    <h4>Strategy Type & Mode</h4>
                    <div class="param-grid">
                        {{ select("param_strategy_type", "Strategy Type", [("indicator", "Indicator"), ("llm", "LLM"), ("hybrid", "Hybrid")]) }}
                        {{ select("param_mode", "Mode", [("quant_only", "Quant Only"), ("llm_only", "LLM Only"), ("hybrid", "Hybrid")]) }}
                        {{ text_input("param_symbol", "Symbol", "BTCUSDT") }}
                    </div>
                </div>

                <!-- Indicator Parameters -->
                <div class="modal-section">
                    <h4>Indicator Parameters</h4>
                    <div class="param-grid">
                        {{ number_input("param_rsi_len", "RSI Length", 1, none, 1) }}
                        {{ number_input("param_rsi_ovb", "RSI Overbought", 0, 100, 1) }}
                        {{ number_input("param_rsi_ovs", "RSI Oversold", 0, 100, 1) }}
                        {{ number_input("param_bb_len", "BB Length", 1, none, 1) }}
                        {{ number_input("param_bb_mult", "BB Multiplier", 0, none, 0.1) }}
                        {{ number_input("param_ema_fast_len", "EMA Fast Length", 1, none, 1) }}
                        {{ number_input("param_ema_slow_len", "EMA Slow Length", 1, none, 1) }}
                        {{ number_input("param_atr_len", "ATR Length", 1, none, 1) }}
                        {{ number_input("param_adx_len", "ADX Length", 1, none, 1) }}
                        {{ number_input("param_vol_ma_len", "Volume MA Length", 1, none, 1) }}
                        {{ number_input("param_vol_mult", "Volume Multiplier", 0, none, 0.1) }}
                    </div>
                </div>

                <!-- Position & Risk Management -->
                <div class="modal-section">
                    <h4>Position & Risk Management</h4>
                    <div class="param-grid">
                        {{ number_input("param_base_position_pct", "Base Position %", 0, 100, 0.1) }}
                        {{ number_input("param_pyramiding", "Pyramiding", 1, none, 1) }}
                        {{ checkbox("param_allow_long", "Allow Long") }}
                        {{ checkbox("param_allow_short", "Allow Short") }}
                        {{ checkbox("param_use_martingale", "Use Martingale") }}
                        <div id="param_martingale_settings" style="display: none;">
                            {{ number_input("param_martingale_mult", "Martingale Multiplier", 1, none, 0.1) }}
                            {{ number_input("param_max_position_size", "Max Position Size", 0.01, 1.0, 0.01) }}
                        </div>
                    </div>
                </div>

                <!-- TP/SL Settings -->
                <div class="modal-section">
                    <h4>TP/SL Settings</h4>
                    <div class="param-grid">
                        {{ checkbox("param_use_tp_sl", "Use TP/SL") }}
                        <div id="param_tp_sl_settings" style="display: none; grid-column: 1 / -1;">
                            <div class="param-grid">
                                {{ number_input("param_tp_long_pct", "TP Long %", 0, none, 0.1) }}
                                {{ number_input("param_sl_long_pct", "SL Long %", 0, none, 0.1) }}
                                {{ number_input("param_tp_short_pct", "TP Short %", 0, none, 0.1) }}
                                {{ number_input("param_sl_short_pct", "SL Short %", 0, none, 0.1) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Filter -->
                <div class="modal-section">
                    <h4>Time Filter</h4>
                    <div class="param-grid">
                        {{ checkbox("param_time_filter_enabled", "Enable Time Filter") }}
                        <div id="param_time_filter_settings" style="display: none; grid-column: 1 / -1;">
                            <div class="param-grid">
                                {{ number_input("param_time_filter_start_hour", "Start Hour (UTC)", 0, 23, 1) }}
                                {{ number_input("param_time_filter_end_hour", "End Hour (UTC)", 0, 23, 1) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Parameters -->
                <div class="modal-section">
                    <h4>LLM Parameters</h4>
                    <div class="param-grid">
                        {{ number_input("param_k_max", "K Max", 0, none, 0.1) }}
                        {{ number_input("param_llm_horizon_hours", "Horizon Hours", 1, none, 1) }}
                        {{ number_input("param_llm_min_prob_edge", "Min Prob Edge", 0, 1, 0.01) }}
                        {{ number_input("param_llm_min_trend_strength", "Min Trend Strength", 0, 1, 0.01) }}
                        {{ number_input("param_llm_refresh_interval_bars", "Refresh Interval (bars)", 1, none, 1) }}
                    </div>
                </div>

                <!-- Trading Rules -->
                <div class="modal-section">
                    <h4>Trading Rules (JSON Format)</h4>
                    {{ textarea("param_rules", "Rules JSON", '{"long_entry": [], "short_entry": [], "long_exit": [], "short_exit": []}', "Enter valid JSON format for trading rules") }}
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <div class="modal-status" id="modal-status"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" id="recalculate-btn">Recalculate</button>
                <button type="button" class="btn btn-success" id="save-params-btn">Save</button>
                <button type="button" class="btn btn-secondary" id="modal-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Lightweight Charts Library -->
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<!-- Config for backtest.js -->
<script>
    window.BACKTEST_CONFIG = {
        strategyName: '{{ name }}',
        symbol: '{{ summary.symbol }}'
    };
</script>

<!-- Backtest page JavaScript -->
<script src="{{ url_for('static', path='js/backtest.js') }}"></script>
{% endblock %}
