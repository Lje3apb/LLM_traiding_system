{% extends "base.html" %}

{% block title %}Run Backtest - {{ name }} - LLM Trading System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Run Backtest: {{ name }}</h2>
    <a href="/ui/strategies/{{ name }}/edit" class="btn btn-secondary">Edit Strategy</a>
</div>

<form method="POST" action="/ui/strategies/{{ name }}/backtest" class="strategy-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="form-section">
        <h3>Data Download from Binance</h3>
        <p class="help-text">Automatically download historical OHLCV data from Binance archive</p>

        <div class="form-row">
            <div class="form-group">
                <label for="download_symbol">Symbol</label>
                <input type="text" id="download_symbol" name="download_symbol" value="{{ config.get('symbol', 'BTCUSDT') }}" placeholder="BTCUSDT">
            </div>

            <div class="form-group">
                <label for="download_interval">Interval</label>
                <select id="download_interval" name="download_interval">
                    <option value="1m">1 minute</option>
                    <option value="5m" selected>5 minutes</option>
                    <option value="15m">15 minutes</option>
                    <option value="30m">30 minutes</option>
                    <option value="1h">1 hour</option>
                    <option value="4h">4 hours</option>
                    <option value="1d">1 day</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="download_start_date">Start Date</label>
                <input type="date" id="download_start_date" name="download_start_date" value="2024-01-01">
            </div>

            <div class="form-group">
                <label for="download_end_date">End Date</label>
                <input type="date" id="download_end_date" name="download_end_date" value="2024-12-31">
            </div>
        </div>

        <div class="form-group">
            <button type="button" id="download_btn" class="btn btn-primary">Download Data</button>
            <span id="download_status" style="margin-left: 10px;"></span>
        </div>

        <div id="download_progress" style="display: none; margin-top: 10px;">
            <div style="background: #e0e0e0; border-radius: 4px; height: 20px; overflow: hidden;">
                <div id="progress_bar" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="progress_text" style="margin-top: 5px; font-size: 14px;"></p>
        </div>
    </div>

    <div class="form-section">
        <h3>Backtest Parameters</h3>

        <div class="form-group">
            <label for="data_path">Select Data File</label>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
                <select id="data_path" name="data_path" required style="flex: 1;">
                    <option value="">-- Select CSV file --</option>
                </select>
                <button type="button" id="refresh_files_btn" class="btn btn-secondary" style="white-space: nowrap;">Refresh</button>
            </div>
            <p class="help-text" id="file_info" style="margin-top: 5px; color: #666;"></p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="initial_equity">Initial Equity</label>
                <input type="number" id="initial_equity" name="initial_equity" value="{{ default_backtest_equity }}" step="100" min="0" required>
            </div>

            <div class="form-group">
                <label for="fee_rate">Fee Rate</label>
                <input type="number" id="fee_rate" name="fee_rate" value="{{ default_commission }}" step="0.0001" min="0" required>
                <p class="help-text">0.001 = 0.1%</p>
            </div>

            <div class="form-group">
                <label for="slippage_bps">Slippage (bps)</label>
                <input type="number" id="slippage_bps" name="slippage_bps" value="{{ default_slippage }}" step="0.1" min="0" required>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>LLM Settings (Optional)</h3>

        <div class="form-group">
            <label>
                <input type="checkbox" name="use_llm" id="use_llm">
                Use LLM (requires Ollama running)
            </label>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="llm_model">LLM Model</label>
                <input type="text" id="llm_model" name="llm_model" value="{{ default_llm_model }}">
            </div>

            <div class="form-group">
                <label for="llm_url">Ollama URL</label>
                <input type="text" id="llm_url" name="llm_url" value="{{ default_llm_url }}">
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-success">Run Backtest</button>
        <a href="/ui/" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<div class="form-section">
    <h3>Strategy Configuration</h3>
    <div class="metrics-grid">
        <div class="metric">
            <span class="metric-label">Type</span>
            <span class="metric-value">{{ config.get('strategy_type', 'N/A') }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Mode</span>
            <span class="metric-value">{{ config.get('mode', 'N/A') }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Symbol</span>
            <span class="metric-value">{{ config.get('symbol', 'N/A') }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Base Size</span>
            <span class="metric-value">{{ config.get('base_size', 'N/A') }}</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const downloadBtn = document.getElementById('download_btn');
    const downloadStatus = document.getElementById('download_status');
    const downloadProgress = document.getElementById('download_progress');
    const progressBar = document.getElementById('progress_bar');
    const progressText = document.getElementById('progress_text');
    const dataPathSelect = document.getElementById('data_path');
    const fileInfo = document.getElementById('file_info');
    const refreshFilesBtn = document.getElementById('refresh_files_btn');

    let filesData = []; // Store file metadata

    // Function to load available CSV files
    async function loadDataFiles() {
        try {
            const response = await fetch('/ui/data/files');
            const data = await response.json();

            filesData = data.files || [];

            // Clear existing options except the first one
            dataPathSelect.innerHTML = '<option value="">-- Select CSV file --</option>';

            // Add file options
            filesData.forEach(file => {
                const option = document.createElement('option');
                option.value = file.path;
                option.textContent = `${file.name} (${file.rows} rows, ${file.size_mb} MB)`;
                dataPathSelect.appendChild(option);
            });

            // If no files, show message
            if (filesData.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- No CSV files found. Download data first --';
                option.disabled = true;
                dataPathSelect.appendChild(option);
            }
        } catch (error) {
            console.error('Failed to load data files:', error);
            fileInfo.textContent = 'Error loading files';
            fileInfo.style.color = 'red';
        }
    }

    // Function to update file info display
    function updateFileInfo() {
        const selectedPath = dataPathSelect.value;
        if (!selectedPath) {
            fileInfo.textContent = '';
            return;
        }

        const file = filesData.find(f => f.path === selectedPath);
        if (file) {
            fileInfo.textContent = `File: ${file.name} | ${file.rows.toLocaleString()} rows | ${file.size_mb} MB`;
            fileInfo.style.color = '#666';
        }
    }

    // Event listeners
    dataPathSelect.addEventListener('change', updateFileInfo);
    refreshFilesBtn.addEventListener('click', loadDataFiles);

    // Load files on page load
    loadDataFiles();

    downloadBtn.addEventListener('click', async function() {
        // Get form values
        const symbol = document.getElementById('download_symbol').value.trim();
        const interval = document.getElementById('download_interval').value;
        const startDate = document.getElementById('download_start_date').value;
        const endDate = document.getElementById('download_end_date').value;

        // Validate inputs
        if (!symbol) {
            alert('Please enter a symbol');
            return;
        }
        if (!startDate || !endDate) {
            alert('Please select start and end dates');
            return;
        }

        // Disable button and show progress
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'Downloading...';
        downloadStatus.textContent = '';
        downloadProgress.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = 'Starting download...';

        try {
            // Prepare form data
            const formData = new FormData();
            formData.append('symbol', symbol);
            formData.append('interval', interval);
            formData.append('start_date', startDate);
            formData.append('end_date', endDate);
            formData.append('csrf_token', '{{ csrf_token }}');

            // Make streaming request
            const response = await fetch('/ui/strategies/{{ name }}/download_data', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Request failed with status ' + response.status);
            }

            // Read streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const {done, value} = await reader.read();

                if (done) break;

                // Decode chunk and add to buffer
                buffer += decoder.decode(value, {stream: true});

                // Process complete lines
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                for (const line of lines) {
                    if (!line.trim()) continue;

                    try {
                        const data = JSON.parse(line);

                        if (data.type === 'progress') {
                            // Update progress bar
                            progressBar.style.width = data.percent + '%';
                            // Show filename and percentage
                            progressText.textContent = `Downloading ${data.filename} (${data.percent}%)`;
                        } else if (data.type === 'info') {
                            progressText.textContent = data.message;
                        } else if (data.type === 'warning') {
                            // Create safe warning element to prevent XSS
                            const warnSpan = document.createElement('span');
                            warnSpan.style.color = 'orange';
                            warnSpan.textContent = '⚠ ' + data.message;
                            downloadStatus.appendChild(document.createElement('br'));
                            downloadStatus.appendChild(warnSpan);
                        } else if (data.type === 'complete') {
                            // Success!
                            progressBar.style.width = '100%';
                            progressText.textContent = data.message;
                            // Create safe success element to prevent XSS
                            const successSpan = document.createElement('span');
                            successSpan.style.color = 'green';
                            successSpan.textContent = '✓ Success! ' + data.rows + ' rows loaded';
                            downloadStatus.innerHTML = '';  // Clear first
                            downloadStatus.appendChild(successSpan);

                            // Reload file list and select the new file
                            await loadDataFiles();
                            dataPathSelect.value = data.file_path;
                            updateFileInfo();

                            // Hide progress after 3 seconds
                            setTimeout(() => {
                                downloadProgress.style.display = 'none';
                            }, 3000);
                        } else if (data.type === 'error') {
                            throw new Error(data.message);
                        }
                    } catch (parseError) {
                        console.error('Failed to parse line:', line, parseError);
                    }
                }
            }

        } catch (error) {
            // Show error - use textContent to prevent XSS
            progressBar.style.width = '0%';
            progressText.textContent = '';
            const errorSpan = document.createElement('span');
            errorSpan.style.color = 'red';
            errorSpan.textContent = '✗ Error: ' + error.message;
            downloadStatus.innerHTML = '';  // Clear first
            downloadStatus.appendChild(errorSpan);

            // Hide progress
            setTimeout(() => {
                downloadProgress.style.display = 'none';
            }, 5000);
        } finally {
            // Re-enable button
            downloadBtn.disabled = false;
            downloadBtn.textContent = 'Download Data';
        }
    });
});
</script>
{% endblock %}
