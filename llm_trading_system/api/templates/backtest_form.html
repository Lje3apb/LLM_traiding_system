{% extends "base.html" %}

{% block title %}Run Backtest - {{ name }} - LLM Trading System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Run Backtest: {{ name }}</h2>
    <a href="/ui/strategies/{{ name }}/edit" class="btn btn-secondary">Edit Strategy</a>
</div>

<form method="POST" action="/ui/strategies/{{ name }}/backtest" class="strategy-form">
    <div class="form-section">
        <h3>Data Download from Binance</h3>
        <p class="help-text">Automatically download historical OHLCV data from Binance archive</p>

        <div class="form-row">
            <div class="form-group">
                <label for="download_symbol">Symbol</label>
                <input type="text" id="download_symbol" name="download_symbol" value="{{ config.get('symbol', 'BTCUSDT') }}" placeholder="BTCUSDT">
            </div>

            <div class="form-group">
                <label for="download_interval">Interval</label>
                <select id="download_interval" name="download_interval">
                    <option value="1m">1 minute</option>
                    <option value="5m" selected>5 minutes</option>
                    <option value="15m">15 minutes</option>
                    <option value="30m">30 minutes</option>
                    <option value="1h">1 hour</option>
                    <option value="4h">4 hours</option>
                    <option value="1d">1 day</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="download_start_date">Start Date</label>
                <input type="date" id="download_start_date" name="download_start_date" value="2024-01-01">
            </div>

            <div class="form-group">
                <label for="download_end_date">End Date</label>
                <input type="date" id="download_end_date" name="download_end_date" value="2024-12-31">
            </div>
        </div>

        <div class="form-group">
            <button type="button" id="download_btn" class="btn btn-primary">Download Data</button>
            <span id="download_status" style="margin-left: 10px;"></span>
        </div>

        <div id="download_progress" style="display: none; margin-top: 10px;">
            <div style="background: #e0e0e0; border-radius: 4px; height: 20px; overflow: hidden;">
                <div id="progress_bar" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="progress_text" style="margin-top: 5px; font-size: 14px;"></p>
        </div>
    </div>

    <div class="form-section">
        <h3>Backtest Parameters</h3>

        <div class="form-group">
            <label for="data_path">Data File Path</label>
            <input type="text" id="data_path" name="data_path" placeholder="data/BTCUSDT_5m_2024-01-01_2024-12-31.csv" required>
            <p class="help-text">Path to CSV file with OHLCV data (will be auto-filled after download)</p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="initial_equity">Initial Equity</label>
                <input type="number" id="initial_equity" name="initial_equity" value="10000.0" step="100" min="0" required>
            </div>

            <div class="form-group">
                <label for="fee_rate">Fee Rate</label>
                <input type="number" id="fee_rate" name="fee_rate" value="0.001" step="0.0001" min="0" required>
                <p class="help-text">0.001 = 0.1%</p>
            </div>

            <div class="form-group">
                <label for="slippage_bps">Slippage (bps)</label>
                <input type="number" id="slippage_bps" name="slippage_bps" value="1.0" step="0.1" min="0" required>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>LLM Settings (Optional)</h3>

        <div class="form-group">
            <label>
                <input type="checkbox" name="use_llm" id="use_llm">
                Use LLM (requires Ollama running)
            </label>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="llm_model">LLM Model</label>
                <input type="text" id="llm_model" name="llm_model" value="llama3.2">
            </div>

            <div class="form-group">
                <label for="llm_url">Ollama URL</label>
                <input type="text" id="llm_url" name="llm_url" value="http://localhost:11434">
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-success">Run Backtest</button>
        <a href="/ui/" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<div class="form-section">
    <h3>Strategy Configuration</h3>
    <div class="metrics-grid">
        <div class="metric">
            <span class="metric-label">Type</span>
            <span class="metric-value">{{ config.get('strategy_type', 'N/A') }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Mode</span>
            <span class="metric-value">{{ config.get('mode', 'N/A') }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Symbol</span>
            <span class="metric-value">{{ config.get('symbol', 'N/A') }}</span>
        </div>
        <div class="metric">
            <span class="metric-label">Base Size</span>
            <span class="metric-value">{{ config.get('base_size', 'N/A') }}</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const downloadBtn = document.getElementById('download_btn');
    const downloadStatus = document.getElementById('download_status');
    const downloadProgress = document.getElementById('download_progress');
    const progressBar = document.getElementById('progress_bar');
    const progressText = document.getElementById('progress_text');
    const dataPathInput = document.getElementById('data_path');

    downloadBtn.addEventListener('click', async function() {
        // Get form values
        const symbol = document.getElementById('download_symbol').value.trim();
        const interval = document.getElementById('download_interval').value;
        const startDate = document.getElementById('download_start_date').value;
        const endDate = document.getElementById('download_end_date').value;

        // Validate inputs
        if (!symbol) {
            alert('Please enter a symbol');
            return;
        }
        if (!startDate || !endDate) {
            alert('Please select start and end dates');
            return;
        }

        // Disable button and show progress
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'Downloading...';
        downloadStatus.textContent = '';
        downloadProgress.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = 'Starting download...';

        try {
            // Prepare form data
            const formData = new FormData();
            formData.append('symbol', symbol);
            formData.append('interval', interval);
            formData.append('start_date', startDate);
            formData.append('end_date', endDate);

            // Make streaming request
            const response = await fetch('/ui/strategies/{{ name }}/download_data', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Request failed with status ' + response.status);
            }

            // Read streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const {done, value} = await reader.read();

                if (done) break;

                // Decode chunk and add to buffer
                buffer += decoder.decode(value, {stream: true});

                // Process complete lines
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                for (const line of lines) {
                    if (!line.trim()) continue;

                    try {
                        const data = JSON.parse(line);

                        if (data.type === 'progress') {
                            // Update progress bar
                            progressBar.style.width = data.percent + '%';
                            // Show filename and percentage
                            progressText.textContent = `Downloading ${data.filename} (${data.percent}%)`;
                        } else if (data.type === 'info') {
                            progressText.textContent = data.message;
                        } else if (data.type === 'warning') {
                            downloadStatus.innerHTML += '<br><span style="color: orange;">⚠ ' + data.message + '</span>';
                        } else if (data.type === 'complete') {
                            // Success!
                            progressBar.style.width = '100%';
                            progressText.textContent = data.message;
                            dataPathInput.value = data.file_path;
                            downloadStatus.innerHTML = '<span style="color: green;">✓ Success! ' + data.rows + ' rows loaded</span>';

                            // Hide progress after 3 seconds
                            setTimeout(() => {
                                downloadProgress.style.display = 'none';
                            }, 3000);
                        } else if (data.type === 'error') {
                            throw new Error(data.message);
                        }
                    } catch (parseError) {
                        console.error('Failed to parse line:', line, parseError);
                    }
                }
            }

        } catch (error) {
            // Show error
            progressBar.style.width = '0%';
            progressText.textContent = '';
            downloadStatus.innerHTML = '<span style="color: red;">✗ Error: ' + error.message + '</span>';

            // Hide progress
            setTimeout(() => {
                downloadProgress.style.display = 'none';
            }, 5000);
        } finally {
            // Re-enable button
            downloadBtn.disabled = false;
            downloadBtn.textContent = 'Download Data';
        }
    });
});
</script>
{% endblock %}
